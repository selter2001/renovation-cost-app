---
phase: 02-core-wizard-kalkulator
plan: 03
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/components/wizard/WorksStep.tsx
  - src/components/wizard/WorkRow.tsx
  - src/components/wizard/CustomWorkForm.tsx
  - src/components/wizard/SummaryStep.tsx
  - src/components/pdf/pdf-fonts.ts
  - src/components/pdf/EstimatePdf.tsx
  - src/components/pdf/EstimatePdfTabular.tsx
  - src/components/pdf/PdfDownloadButton.tsx
  - src/pages/WizardPage.tsx
autonomous: true

must_haves:
  truths:
    - "Uzytkownik widzi 7 predefiniowanych typow prac per pokoj z przelacznikami wl/wyl, moze ustawic cene jednostkowa, ilosc oblicza sie automatycznie z wymiarow"
    - "Uzytkownik moze dodac wlasna prace (nazwa, jednostka, ilosc, cena) per pokoj"
    - "Krok podsumowania pokazuje detale kazdego pokoju z pracami, kosztami per praca, sumami per pokoj i sumarycznymi netto/VAT/brutto"
    - "Uzytkownik moze wyeksportowac wycene do PDF w formacie standardowym lub tabelarycznym -- PDF zawiera polskie znaki i dane pokoi/prac/kosztow"
    - "PDF respektuje wybrany jezyk (PL lub EN)"
  artifacts:
    - path: "src/components/wizard/WorksStep.tsx"
      provides: "Krok 3 -- typy prac per pokoj z togglem, cena, iloscia"
      contains: "toggleWork"
    - path: "src/components/wizard/SummaryStep.tsx"
      provides: "Krok 4 -- podsumowanie wyceny z detalami"
      contains: "calcRoomTotal"
    - path: "src/components/pdf/EstimatePdf.tsx"
      provides: "PDF standardowy z @react-pdf/renderer"
      contains: "Document"
    - path: "src/components/pdf/EstimatePdfTabular.tsx"
      provides: "PDF tabelaryczny z @react-pdf/renderer"
      contains: "Document"
    - path: "src/components/pdf/PdfDownloadButton.tsx"
      provides: "Przycisk eksportu PDF z PDFDownloadLink"
      contains: "PDFDownloadLink"
    - path: "src/components/pdf/pdf-fonts.ts"
      provides: "Rejestracja Roboto TTF z CDN"
      contains: "Font.register"
  key_links:
    - from: "src/components/wizard/WorksStep.tsx"
      to: "src/stores/wizard-store.ts"
      via: "toggleWork, setWorkPrice, addCustomWork, removeCustomWork"
      pattern: "useWizardStore"
    - from: "src/components/wizard/WorksStep.tsx"
      to: "src/lib/calc.ts"
      via: "getWorkQuantity, calcWorkCost"
      pattern: "getWorkQuantity"
    - from: "src/components/wizard/SummaryStep.tsx"
      to: "src/lib/calc.ts"
      via: "calcRoomTotal, calcNetTotal, calcGrossFromNet"
      pattern: "calcRoomTotal"
    - from: "src/components/pdf/EstimatePdf.tsx"
      to: "src/components/pdf/pdf-fonts.ts"
      via: "side-effect import rejestrujacy fonty"
      pattern: "import.*pdf-fonts"
    - from: "src/components/pdf/PdfDownloadButton.tsx"
      to: "@react-pdf/renderer"
      via: "PDFDownloadLink"
      pattern: "PDFDownloadLink"
    - from: "src/pages/WizardPage.tsx"
      to: "src/components/wizard/WorksStep.tsx"
      via: "lazy render w kroku 2"
      pattern: "WorksStep"
---

<objective>
Zbudowac krok Works (7 predefiniowanych prac z toggle/cena/ilosc + custom works), krok Summary (detale per pokoj z kosztami) i kompletny eksport PDF (standardowy + tabelaryczny z polskimi znakami i wsparciem i18n). Podlaczyc do placeholderow w WizardPage.

Purpose: Zamyka Phase 2 -- po tym planie uzytkownik ma kompletny kalkulator od dodawania pokoi po eksport PDF.
Output: WorksStep, SummaryStep, PDF standardowy i tabelaryczny, przycisk Pobierz PDF -- kompletny wizard.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-wizard-kalkulator/02-RESEARCH.md
@.planning/phases/02-core-wizard-kalkulator/02-01-SUMMARY.md
@.planning/phases/02-core-wizard-kalkulator/02-02-SUMMARY.md
@src/types/wizard.ts
@src/stores/wizard-store.ts
@src/lib/calc.ts
@src/lib/format.ts
@src/pages/WizardPage.tsx
@src/components/wizard/FloatingSummary.tsx
@src/i18n/locales/pl/common.json
@src/i18n/locales/en/common.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: WorksStep with 7 predefined works, toggle/price/quantity, custom works form</name>
  <files>src/components/wizard/WorksStep.tsx, src/components/wizard/WorkRow.tsx, src/components/wizard/CustomWorkForm.tsx, src/pages/WizardPage.tsx</files>
  <action>
**src/components/wizard/WorksStep.tsx** -- Krok 3: typy prac per pokoj:

Import useWizardStore (rooms, toggleWork, setWorkPrice, addCustomWork, removeCustomWork). Import PREDEFINED_WORKS from @/types/wizard. Import getWorkQuantity, calcWorkCost, calcCustomWorkCost from @/lib/calc. Import formatPLN from @/lib/format. Import parseInputToGrosze from @/lib/format. Import useTranslation. Import WorkRow and CustomWorkForm.

Layout: For each room, render a section with room name heading. Inside, render:

1. **Predefiniowane prace** (7 items): Map PREDEFINED_WORKS and render WorkRow for each. Pass: room, workType, current roomWork state (room.works[workType.id]).

2. **Custom works section**: List existing custom works for this room. Below: CustomWorkForm to add new custom work.

3. **Suma pokoju**: Display calcRoomTotal(room) formatted with formatPLN as subtotal per room.

If multiple rooms, use visual separators (hr or border) between room sections. Show room icon + name as section header.

**src/components/wizard/WorkRow.tsx** -- Wiersz pracy:

Props: room: Room, workType: WorkType, roomWork: RoomWork | undefined.

Import Switch from shadcn (toggle wl/wyl). Import Input from shadcn (cena jednostkowa). Import useWizardStore (toggleWork, setWorkPrice). Import getWorkQuantity, calcWorkCost from @/lib/calc. Import formatPLN, parseInputToGrosze from @/lib/format. Import useTranslation.

Layout: Responsive row (flex, wrap on mobile):
- Left: Switch component (checked = roomWork?.enabled). On toggle: toggleWork(room.id, workType.id).
- Name: t(workType.labelKey) -- translated work name.
- Quantity: Auto-calculated. Display getWorkQuantity(room, workType.id) with unit t('dimensions.unit.' + workType.unit). Read-only, muted color.
- Unit price: Input type="number" step="0.01" min="0". Display value in PLN (divide roomWork.unitPrice / 100 for display). On change: parseInputToGrosze(e.target.value) then setWorkPrice(room.id, workType.id, grosze). Placeholder "0,00". Disabled when switch is off.
- Cost: calcWorkCost(quantity, unitPrice) formatted with formatPLN. Read-only display. Show only when enabled.

Visual: Disabled (switch off) rows are dimmed (opacity-50). Enabled rows are full opacity.

**src/components/wizard/CustomWorkForm.tsx** -- Formularz custom work:

Props: roomId: string.

Import useWizardStore (addCustomWork, removeCustomWork). Import Input, Button, Badge from shadcn. Import useTranslation.

State: name (string), unit (WorkUnit -- default 'm2'), quantity (number), unitPrice (string for input display).

Form layout: Inline form (flex gap-2) with:
- Input for name (t('works.customName'), placeholder)
- Select or button group for unit (m2, mb, szt)
- Input for quantity (number, step=0.01)
- Input for unitPrice (PLN, step=0.01)
- Button "+" to add (calls addCustomWork with parsed values, resets form)

Below form: list of existing customWorks for this room. Each shows name, quantity, unit, unitPrice, cost, and a delete (X) button that calls removeCustomWork(roomId, work.id).

WAZNE: Custom works have unitPrice directly on the CustomWork object. When adding, parse the price input to grosze with parseInputToGrosze.

**src/pages/WizardPage.tsx** -- Podlacz WorksStep:

Replace placeholder div for step 2 (index 2) with `<WorksStep />`. Import WorksStep from '@/components/wizard/WorksStep'. Leave SummaryStep placeholder for Task 2.
  </action>
  <verify>
`pnpm build` przechodzi. Krok 3 (Works) pokazuje 7 predefiniowanych prac per pokoj. Switch wlacza/wylacza prace. Input ceny zmienia koszt. Ilosc oblicza sie automatycznie z wymiarow. Custom work mozna dodac i usunac. FloatingSummary reaguje na zmiany w czasie rzeczywistym.
  </verify>
  <done>WorksStep renderuje 7 predefiniowanych prac per pokoj z togglem Switch, inputem ceny, automatyczna iloscia i wyliczonym kosztem. CustomWorkForm pozwala dodac/usunac wlasne prace. Suma per pokoj wyswietla sie. FloatingSummary aktualizuje sie w czasie rzeczywistym.</done>
</task>

<task type="auto">
  <name>Task 2: SummaryStep with breakdown, PDF export (standard + tabular) with Polish font and i18n</name>
  <files>src/components/wizard/SummaryStep.tsx, src/components/pdf/pdf-fonts.ts, src/components/pdf/EstimatePdf.tsx, src/components/pdf/EstimatePdfTabular.tsx, src/components/pdf/PdfDownloadButton.tsx, src/pages/WizardPage.tsx</files>
  <action>
**src/components/wizard/SummaryStep.tsx** -- Krok 4: podsumowanie:

Import useWizardStore (rooms, vatRate). Import calcRoomTotal, calcNetTotal, calcVat, calcGrossFromNet, getWorkQuantity, calcWorkCost, calcCustomWorkCost from @/lib/calc. Import formatPLN from @/lib/format. Import PREDEFINED_WORKS from @/types/wizard. Import useTranslation. Import PdfDownloadButton. Import Card from shadcn. Import Badge from shadcn.

Layout: Detailed breakdown of entire estimate:

1. **Per room section**: For each room, render Card with:
   - Header: room name + icon + room subtotal (formatPLN(calcRoomTotal(room)))
   - Body: table/list of active works (predefined + custom):
     - Work name | Quantity + unit | Unit price | Cost
   - Only show enabled predefined works and all custom works
   - For predefined: name = t(workType.labelKey), quantity = getWorkQuantity(room, workType.id), unitPrice from room.works[id].unitPrice
   - For custom: name = work.name, quantity = work.quantity, unitPrice = work.unitPrice

2. **Totals section**: Below all rooms:
   - Netto: formatPLN(net) -- large, clear
   - VAT {vatRate}%: formatPLN(vat)
   - Brutto: formatPLN(gross) -- largest, font-bold, text-brand

3. **Export section**: PdfDownloadButton with format selector (standard / tabular). Use two buttons or a toggle group:
   - t('summary.pdfStandard') / t('summary.pdfTabular')
   - Selected format state (useState<'standard' | 'tabular'>('standard'))
   - Pass selected format to PdfDownloadButton

If rooms.length === 0, show empty state: t('summary.noRooms').

**src/components/pdf/pdf-fonts.ts** -- Rejestracja fontow:

Side-effect module. Import { Font } from '@react-pdf/renderer'.

Register Roboto from CDN (from Research Pattern 5):
```typescript
Font.register({
  family: 'Roboto',
  fonts: [
    { src: 'https://cdnjs.cloudflare.com/ajax/libs/ink/3.1.10/fonts/Roboto/roboto-light-webfont.ttf', fontWeight: 300 },
    { src: 'https://cdnjs.cloudflare.com/ajax/libs/ink/3.1.10/fonts/Roboto/roboto-regular-webfont.ttf', fontWeight: 400 },
    { src: 'https://cdnjs.cloudflare.com/ajax/libs/ink/3.1.10/fonts/Roboto/roboto-medium-webfont.ttf', fontWeight: 500 },
    { src: 'https://cdnjs.cloudflare.com/ajax/libs/ink/3.1.10/fonts/Roboto/roboto-bold-webfont.ttf', fontWeight: 700 },
  ],
})
```

UWAGA: To musi byc TTF (nie WOFF2). Ten plik jest importowany jako side-effect w komponentach PDF.

**src/components/pdf/EstimatePdf.tsx** -- PDF standardowy:

Import { Document, Page, Text, View, StyleSheet } from '@react-pdf/renderer'. Import './pdf-fonts' (side-effect). Import types Room from @/types/wizard. Import PREDEFINED_WORKS. Import calc functions.

Props: rooms: Room[], vatRate: 8 | 23, language: 'pl' | 'en', translations: Record<string, string> (pre-resolved i18n strings -- do NOT import i18next inside PDF component, pass translations as plain object).

WAZNE: @react-pdf/renderer renderuje w osobnym watku (worker). NIE moze uzywac React hooks ani kontekstu (useTranslation nie zadziala). Wszystkie tlumaczenia MUSZA byc przekazane jako props.

Prepare translations object in PdfDownloadButton/SummaryStep before passing to PDF component:
```typescript
const pdfTranslations = {
  title: t('summary.title'),
  room: t('summary.room'),
  work: t('summary.work'),
  // ... all needed strings
}
```

StyleSheet: fontFamily 'Roboto', fontSize 10, page padding 40, backgroundColor white.

Layout:
- Title: "Wycena remontu" / "Renovation Estimate" (from translations), fontSize 18, fontWeight 700, marginBottom 16
- Date: current date formatted
- For each room:
  - Room name heading, fontSize 13, fontWeight 500, marginTop 12
  - For each active work: row with work name, quantity + unit, unit price, cost -- laid out as flex row with justifyContent 'space-between'
  - Room subtotal: aligned right, fontWeight 500, borderTop
- Totals section:
  - Net total, VAT line, Gross total (fontWeight 700, fontSize 14)
- Footer: "Generated by RenoCost" small text at bottom

**src/components/pdf/EstimatePdfTabular.tsx** -- PDF tabelaryczny:

Same props as EstimatePdf. Different layout:

StyleSheet: Table-like layout using View with flexDirection 'row' for columns.

Layout:
- Title + date (same as standard)
- Table header row: Room | Work | Qty | Unit | Price/unit | Cost -- with background color (#f1f5f9), fontWeight 500
- Table body: For each room, for each active work, one row with all columns
  - First row of room shows room name, subsequent rows leave room column empty (merge effect)
  - Alternating row background (#ffffff, #f8fafc) for readability
- Subtotal row per room (bold, right-aligned cost)
- Totals section at bottom: Net, VAT, Gross (similar to standard)

Column widths (percentage): Room 18%, Work 22%, Qty 12%, Unit 8%, Price 18%, Cost 22%.

Use borderBottom for rows. Consistent padding paddingVertical 4, paddingHorizontal 6.

**src/components/pdf/PdfDownloadButton.tsx** -- Przycisk eksportu:

Import { PDFDownloadLink } from '@react-pdf/renderer'. Import Button from shadcn. Import Skeleton from shadcn. Import EstimatePdf and EstimatePdfTabular. Import useTranslation.

Props: rooms: Room[], vatRate: 8 | 23, format: 'standard' | 'tabular'.

Build translations object from t() calls -- resolve all needed i18n keys into plain strings.

Determine current language from i18next (i18n.language).

Render:
```tsx
<PDFDownloadLink
  document={format === 'standard'
    ? <EstimatePdf rooms={rooms} vatRate={vatRate} language={lang} translations={pdfTranslations} />
    : <EstimatePdfTabular rooms={rooms} vatRate={vatRate} language={lang} translations={pdfTranslations} />
  }
  fileName={`wycena-${new Date().toISOString().slice(0,10)}.pdf`}
>
  {({ loading, error }) => (
    <Button disabled={loading || !!error} variant="default" className="bg-brand text-brand-foreground">
      {loading ? t('summary.pdfGenerating') : error ? 'Error' : t('summary.exportPdf')}
    </Button>
  )}
</PDFDownloadLink>
```

When loading, optionally show Skeleton or spinner next to button.

**src/pages/WizardPage.tsx** -- Podlacz SummaryStep:

Replace placeholder div for step 3 (index 3) with `<SummaryStep />`. Import SummaryStep. Now all 4 steps are real components.

UWAGA na responsywnosc: PDF generowanie moze trwac 1-2 sekundy. Button musi jasno komunikowac "Generowanie..." podczas ladowania. Nie pozwol na podwojne klikniecie (disabled={loading}).
  </action>
  <verify>
`pnpm build` przechodzi. Krok 4 (Summary) pokazuje detale kazdego pokoju z pracami i kosztami. Suma netto/VAT/brutto jest poprawna. Przycisk "Pobierz PDF" generuje plik PDF. PDF standardowy i tabelaryczny zawieraja prawidlowe dane. Polskie znaki (ą ę ó ź ć ś ł ń ż) sa czytelne w PDF. Zmiana jezyka na EN zmienia tresci w PDF.
  </verify>
  <done>SummaryStep pokazuje detale per pokoj z pracami, iloscia, cena i kosztem. Totals netto/VAT/brutto wyswietlaja sie poprawnie. PDF standardowy i tabelaryczny generuja sie z poprawna typografia polskich znakow. PDFDownloadLink pobiera plik. Zmiana jezyka na EN zmienia tresc PDF. Wszystkie 4 kroki wizarda sa kompletne.</done>
</task>

</tasks>

<verification>
1. `pnpm build` przechodzi bez bledow TypeScript
2. Krok 3 (Works): 7 predefiniowanych prac per pokoj z toggle, cena, automatyczna iloscia
3. Custom works: dodawanie, usuwanie, koszt przelicza sie
4. FloatingSummary aktualizuje sie przy zmianach prac/cen
5. Krok 4 (Summary): detale per pokoj, totals netto/VAT/brutto
6. PDF standardowy: polskie znaki, dane pokoi/prac/kosztow/sum
7. PDF tabelaryczny: kolumny, polskie znaki, dane pokoi/prac/kosztow/sum
8. Zmiana jezyka na EN zmienia tresc kroku Summary i PDF
9. Kompletny flow: pokoje -> wymiary -> prace -> podsumowanie -> PDF
</verification>

<success_criteria>
- Uzytkownik w kroku 3 widzi 7 prac (malowanie, gruntowanie itd.) z przelacznikami per pokoj
- Wlaczenie pracy i wpisanie ceny 25 zl/m2 przelicza koszt na podstawie wymiarow pokoju
- Dodanie custom work "Elektryka" 10 szt x 150 zl pokazuje koszt 1500 zl
- FloatingSummary pokazuje aktualna sume w czasie rzeczywistym
- Krok 4 pokazuje tabelaryczny breakdown: per pokoj, per praca, z sumami
- Klikniecie "Pobierz PDF" (standardowy) pobiera plik wycena-YYYY-MM-DD.pdf
- PDF zawiera polskie znaki (ą ę ó ź ć ś ł ń ż) poprawnie
- Zmiana formatu na tabelaryczny i ponowne pobranie daje PDF z tabela
- Przelaczenie jezyka na EN i pobranie PDF daje angielsle tresci
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-wizard-kalkulator/02-03-SUMMARY.md`
</output>
