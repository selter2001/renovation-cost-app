---
phase: 03-auth-cloud-save
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase.ts
  - src/stores/auth-store.ts
  - src/types/database.ts
  - src/components/auth/AuthInit.tsx
  - src/App.tsx
  - .env.example
  - .env.local
  - supabase/schema.sql
autonomous: false
user_setup:
  - service: supabase
    why: "Authentication and database for cloud save"
    env_vars:
      - name: VITE_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: VITE_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon public key"
    dashboard_config:
      - task: "Enable Email Auth with autoconfirm ON"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email"
      - task: "Run schema.sql in SQL Editor to create quotes table + RLS policies"
        location: "Supabase Dashboard -> SQL Editor"
      - task: "Add redirect URL to allowlist"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Redirect URLs"
        details: "Add the GitHub Pages URL pattern (e.g. https://username.github.io/przerobka/**)"

must_haves:
  truths:
    - "Supabase client initializes without errors when env vars are set"
    - "Auth store provides user/session/isLoading state to consuming components"
    - "AuthInit listens to onAuthStateChange and syncs session to auth store"
    - "App shows loading state during initial session check (no flash of unauthenticated content)"
    - "Database types match the quotes table schema"
  artifacts:
    - path: "src/lib/supabase.ts"
      provides: "Supabase client singleton with PKCE flow"
      contains: "flowType.*pkce"
    - path: "src/stores/auth-store.ts"
      provides: "Auth state management (user, session, isLoading)"
      exports: ["useAuthStore"]
    - path: "src/types/database.ts"
      provides: "TypeScript types for Supabase database schema"
      contains: "quotes"
    - path: "src/components/auth/AuthInit.tsx"
      provides: "Auth listener initialization component"
      contains: "onAuthStateChange"
    - path: ".env.example"
      provides: "Documentation of required env vars"
      contains: "VITE_SUPABASE"
    - path: "supabase/schema.sql"
      provides: "Database schema with RLS policies"
      contains: "ROW LEVEL SECURITY"
  key_links:
    - from: "src/lib/supabase.ts"
      to: "import.meta.env.VITE_SUPABASE_*"
      via: "env var read"
      pattern: "import\\.meta\\.env\\.VITE_SUPABASE"
    - from: "src/components/auth/AuthInit.tsx"
      to: "src/stores/auth-store.ts"
      via: "setAuth called in onAuthStateChange callback"
      pattern: "setAuth.*session"
    - from: "src/App.tsx"
      to: "src/components/auth/AuthInit.tsx"
      via: "AuthInit wraps RouterProvider"
      pattern: "AuthInit"
---

<objective>
Set up Supabase client, auth state management, and database foundation for Phase 3.

Purpose: All auth UI and estimates CRUD in later plans depend on these primitives -- the Supabase client singleton, auth store, database types, and auth initialization listener.

Output: Working Supabase connection, auth store synced via onAuthStateChange, database types, SQL schema reference file, and .env.example for onboarding.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-auth-cloud-save/03-RESEARCH.md
@src/App.tsx
@src/stores/wizard-store.ts
@src/types/wizard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase SDK + create client, auth store, database types, and schema SQL</name>
  <files>
    src/lib/supabase.ts
    src/stores/auth-store.ts
    src/types/database.ts
    .env.example
    .env.local
    supabase/schema.sql
  </files>
  <action>
    1. Install @supabase/supabase-js:
       `pnpm add @supabase/supabase-js`

    2. Create `.env.example` (committed to git) with:
       ```
       VITE_SUPABASE_URL=https://your-project.supabase.co
       VITE_SUPABASE_ANON_KEY=your-anon-key
       ```

    3. Create `.env.local` (NOT committed, already in .gitignore) with the actual Supabase project values:
       - URL: `https://nirhjivalmvuvxxbkjwk.supabase.co`
       - Anon key: Check if the user has it available. If not, leave a placeholder and the user_setup checkpoint will handle it.

    4. Create `src/lib/supabase.ts`:
       - Import `createClient` from `@supabase/supabase-js`
       - Import `Database` type from `@/types/database`
       - Read `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY` from `import.meta.env`
       - Throw clear error if either env var is missing (do NOT silently fail)
       - Create and export `supabase` client with config:
         - `auth.flowType: 'pkce'` (CRITICAL: avoids hash fragment conflict with HashRouter)
         - `auth.detectSessionInUrl: true`
         - `auth.persistSession: true`
         - `auth.autoRefreshToken: true`

    5. Create `src/stores/auth-store.ts`:
       - Zustand store (NOT persisted -- Supabase manages its own session in localStorage)
       - State: `user: User | null`, `session: Session | null`, `isLoading: boolean` (starts `true`)
       - Actions: `setAuth(user, session)` -- sets user+session and `isLoading: false`
       - Actions: `setLoading(loading)` -- sets isLoading
       - Import `User` and `Session` types from `@supabase/supabase-js`

    6. Create `src/types/database.ts`:
       - TypeScript interface `Database` matching Supabase generated types format
       - Define `public.Tables.quotes` with Row, Insert, Update types
       - Row: `id: string, user_id: string, name: string, data: QuoteData, created_at: string, updated_at: string`
       - `QuoteData` type: `{ rooms: Room[], vatRate: 8 | 23 }` -- import Room from `@/types/wizard`
       - Insert: id/created_at/updated_at optional
       - Update: all fields optional except id never updated

    7. Create `supabase/schema.sql`:
       - Full SQL schema from research (CREATE TABLE IF NOT EXISTS quotes, RLS policies, index, updated_at trigger)
       - This is a REFERENCE file -- user runs it manually in Supabase SQL Editor
       - Add comment at top: "-- Run this in Supabase Dashboard > SQL Editor"
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes (no type errors)
    - `pnpm lint` passes
    - `supabase.ts` imports and exports correctly
    - `auth-store.ts` exports `useAuthStore`
    - `database.ts` exports `Database` and `QuoteData` types
    - `.env.example` exists and is NOT in .gitignore
    - `.env.local` is in .gitignore (already is)
  </verify>
  <done>
    Supabase SDK installed. Client singleton created with PKCE flow. Auth store created with user/session/isLoading. Database types defined matching quotes table schema. SQL schema reference file ready. Env vars documented in .env.example.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AuthInit component and wire into App.tsx</name>
  <files>
    src/components/auth/AuthInit.tsx
    src/App.tsx
  </files>
  <action>
    1. Create `src/components/auth/AuthInit.tsx`:
       - Accepts `children: React.ReactNode` prop
       - In `useEffect`, subscribe to `supabase.auth.onAuthStateChange`:
         - On any event: call `setAuth(session?.user ?? null, session)` -- keeps callback synchronous (CRITICAL: no async in callback -- causes deadlocks)
         - This handles `INITIAL_SESSION`, `SIGNED_IN`, `SIGNED_OUT`, `TOKEN_REFRESHED`, `PASSWORD_RECOVERY`
       - Cleanup: `subscription.unsubscribe()` in useEffect return
       - Render: if `isLoading`, show a minimal full-page centered spinner or skeleton (not blank screen)
         - Use a simple `div` with `animate-spin` Tailwind class and a circular SVG, or use the existing Skeleton component
         - This prevents flash of unauthenticated content (Pitfall 2 from research)
       - When not loading, render `{children}`

    2. Update `src/App.tsx`:
       - Wrap `RouterProvider` with `AuthInit`:
         ```tsx
         function App() {
           return (
             <AuthInit>
               <RouterProvider router={router} />
             </AuthInit>
           )
         }
         ```
       - Import `AuthInit` from `@/components/auth/AuthInit`

    IMPORTANT: The existing wizard functionality must remain completely unchanged. AuthInit is purely additive -- it wraps the app and syncs auth state, nothing else.
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes
    - `pnpm build` succeeds
    - `pnpm dev` starts without errors (even without valid Supabase env vars, it should throw a clear error in console, not crash silently)
    - AuthInit renders children after initial session check
  </verify>
  <done>
    AuthInit component listens to onAuthStateChange, syncs to auth store, shows loading state during initial check. App.tsx wraps RouterProvider with AuthInit. No flash of unauthenticated content.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: User configures Supabase project</name>
  <action>
    The user must configure their Supabase project before auth UI can be tested:

    1. **Set env vars in `.env.local`:**
       - `VITE_SUPABASE_URL` -- from Supabase Dashboard > Settings > API > Project URL
       - `VITE_SUPABASE_ANON_KEY` -- from Supabase Dashboard > Settings > API > anon public key

    2. **Run database schema:**
       - Open Supabase Dashboard > SQL Editor
       - Paste contents of `supabase/schema.sql` and run
       - Verify `quotes` table exists with RLS enabled

    3. **Enable email auth with autoconfirm:**
       - Supabase Dashboard > Authentication > Providers > Email
       - Ensure "Enable Email Signup" is ON
       - Set "Confirm email" to OFF (autoconfirm for MVP)

    4. **Add redirect URL:**
       - Supabase Dashboard > Authentication > URL Configuration > Redirect URLs
       - Add: `http://localhost:5173/**` (for local dev)
       - Add: `https://{username}.github.io/przerobka/**` (for production, if applicable)
  </action>
  <how-to-verify>
    After configuration:
    1. Run `pnpm dev`
    2. Open browser console -- should see NO Supabase errors
    3. The app should load normally (wizard still works as before)
  </how-to-verify>
  <resume-signal>Type "configured" when Supabase project is set up</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` -- no type errors
2. `pnpm build` -- builds successfully
3. `pnpm dev` -- app starts, wizard works identically to Phase 2
4. Browser console shows no Supabase initialization errors (when env vars are set)
5. `useAuthStore.getState()` returns `{ user: null, session: null, isLoading: false }` when not logged in
</verification>

<success_criteria>
- Supabase client singleton exists with PKCE flow configured
- Auth store provides reactive user/session/isLoading state
- AuthInit listens to auth state changes and prevents flash of unauthed content
- Database types are defined and match SQL schema
- SQL schema file ready for user to run
- Existing wizard functionality is completely unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-cloud-save/03-01-SUMMARY.md`
</output>
