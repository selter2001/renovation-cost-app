---
phase: 03-auth-cloud-save
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/auth/LoginForm.tsx
  - src/components/auth/SignUpForm.tsx
  - src/components/auth/ResetPasswordForm.tsx
  - src/components/auth/UpdatePasswordForm.tsx
  - src/components/auth/UserMenu.tsx
  - src/pages/LoginPage.tsx
  - src/pages/ResetPasswordPage.tsx
  - src/pages/UpdatePasswordPage.tsx
  - src/components/layout/Navbar.tsx
  - src/router/index.tsx
  - src/i18n/locales/pl/common.json
  - src/i18n/locales/en/common.json
autonomous: true

must_haves:
  truths:
    - "Guest user can use the wizard identically to Phase 2 (AUTH-01)"
    - "User can sign up with email+password and is immediately logged in (AUTH-02, autoconfirm)"
    - "User can sign in with email+password (AUTH-03)"
    - "User can sign out and is redirected to home (AUTH-03)"
    - "Session persists after page refresh -- user stays logged in (AUTH-04)"
    - "User can request password reset email (AUTH-05)"
    - "User can set new password after clicking reset link (AUTH-05)"
    - "Navbar shows Login button when not authenticated, shows user menu when authenticated"
    - "All auth UI text is translated PL/EN"
  artifacts:
    - path: "src/components/auth/LoginForm.tsx"
      provides: "Email+password sign-in form"
      contains: "signInWithPassword"
    - path: "src/components/auth/SignUpForm.tsx"
      provides: "Email+password registration form"
      contains: "signUp"
    - path: "src/components/auth/ResetPasswordForm.tsx"
      provides: "Password reset request form"
      contains: "resetPasswordForEmail"
    - path: "src/components/auth/UpdatePasswordForm.tsx"
      provides: "New password form (after reset link)"
      contains: "updateUser"
    - path: "src/components/auth/UserMenu.tsx"
      provides: "Navbar dropdown for authenticated user"
      contains: "signOut"
    - path: "src/pages/LoginPage.tsx"
      provides: "Login/SignUp page with tab switching"
    - path: "src/router/index.tsx"
      provides: "Routes for login, reset-password, update-password"
      contains: "login.*reset-password.*update-password"
  key_links:
    - from: "src/components/auth/LoginForm.tsx"
      to: "src/lib/supabase.ts"
      via: "supabase.auth.signInWithPassword"
      pattern: "supabase\\.auth\\.signInWithPassword"
    - from: "src/components/auth/UserMenu.tsx"
      to: "src/stores/auth-store.ts"
      via: "useAuthStore selector for user"
      pattern: "useAuthStore"
    - from: "src/components/layout/Navbar.tsx"
      to: "src/components/auth/UserMenu.tsx"
      via: "UserMenu component rendered in Navbar"
      pattern: "UserMenu"
    - from: "src/router/index.tsx"
      to: "src/pages/LoginPage.tsx"
      via: "Route /login"
      pattern: "path.*login"
---

<objective>
Build the complete auth UI: login, signup, password reset forms, user menu in navbar, and auth-related routes.

Purpose: Users can create accounts, sign in/out, reset passwords, and the navbar reflects auth state. Guest mode (wizard without login) remains fully functional.

Output: Complete auth flow UI with 4 form components, 3 new pages, UserMenu in Navbar, and all auth routes.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-auth-cloud-save/03-RESEARCH.md
@.planning/phases/03-auth-cloud-save/03-01-SUMMARY.md
@src/lib/supabase.ts
@src/stores/auth-store.ts
@src/components/layout/Navbar.tsx
@src/router/index.tsx
@src/i18n/locales/pl/common.json
@src/i18n/locales/en/common.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth form components + pages + routes + i18n keys</name>
  <files>
    src/components/auth/LoginForm.tsx
    src/components/auth/SignUpForm.tsx
    src/components/auth/ResetPasswordForm.tsx
    src/components/auth/UpdatePasswordForm.tsx
    src/pages/LoginPage.tsx
    src/pages/ResetPasswordPage.tsx
    src/pages/UpdatePasswordPage.tsx
    src/router/index.tsx
    src/i18n/locales/pl/common.json
    src/i18n/locales/en/common.json
  </files>
  <action>
    **Add i18n keys** to both `pl/common.json` and `en/common.json`:
    - `auth.login` / `auth.signup` / `auth.logout`
    - `auth.email` / `auth.password` / `auth.confirmPassword`
    - `auth.loginButton` / `auth.signupButton`
    - `auth.noAccount` / `auth.hasAccount` (switch links)
    - `auth.forgotPassword` / `auth.resetPassword` / `auth.sendResetLink`
    - `auth.resetSent` (confirmation message after sending reset email)
    - `auth.updatePassword` / `auth.newPassword` / `auth.updatePasswordButton`
    - `auth.passwordUpdated` (success message)
    - `auth.myEstimates` (for user menu)
    - `auth.errors.invalidCredentials` / `auth.errors.emailTaken` / `auth.errors.weakPassword` / `auth.errors.generic`

    **Install shadcn components if not yet present:**
    - `label` (for form fields)
    - `tabs` (for login/signup tab switching on LoginPage)
    - Check which are already installed before running `pnpm dlx shadcn@latest add`

    **Create `src/components/auth/LoginForm.tsx`:**
    - Email + password inputs with labels (shadcn Input + Label)
    - Submit button that calls `supabase.auth.signInWithPassword({ email, password })`
    - Error display (use auth error mapping from i18n keys)
    - Loading state on button during sign-in
    - Link to "Forgot password?" -> navigates to `#/reset-password`
    - On successful sign-in, navigate to `#/` (home) or `#/wizard` (use `useNavigate` from react-router)
    - Form validation: email required, password required (min 6 chars to match Supabase default)

    **Create `src/components/auth/SignUpForm.tsx`:**
    - Email + password + confirm password inputs
    - Submit button that calls `supabase.auth.signUp({ email, password })`
    - With autoconfirm ON, user is immediately logged in after signUp (data.session is non-null)
    - Error display (email already taken, weak password)
    - On success, navigate to `#/` (home)
    - Form validation: email required, passwords match, min 6 chars

    **Create `src/components/auth/ResetPasswordForm.tsx`:**
    - Email input + submit button
    - Calls `supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + import.meta.env.BASE_URL + '#/update-password' })`
    - On success, show confirmation message (reset link sent)
    - Note: redirectTo with hash may need testing. If it doesn't work, use root URL and handle via onAuthStateChange PASSWORD_RECOVERY event in AuthInit.

    **Create `src/components/auth/UpdatePasswordForm.tsx`:**
    - New password + confirm password inputs
    - Calls `supabase.auth.updateUser({ password: newPassword })`
    - On success, show confirmation and navigate to `#/` after short delay
    - This page is reached after clicking the password reset email link

    **Create `src/pages/LoginPage.tsx`:**
    - Centered card with glassmorphism styling (bg-card/80 backdrop-blur-md border-border/50 shadow-xl)
    - shadcn Tabs with two tabs: Login and Sign Up
    - Login tab renders `<LoginForm />`, Sign Up tab renders `<SignUpForm />`
    - If user is already authenticated (check useAuthStore), redirect to home

    **Create `src/pages/ResetPasswordPage.tsx`:**
    - Centered card with `<ResetPasswordForm />`
    - Back link to `#/login`

    **Create `src/pages/UpdatePasswordPage.tsx`:**
    - Centered card with `<UpdatePasswordForm />`
    - Only accessible when session exists (PASSWORD_RECOVERY event sets session)

    **Update `src/router/index.tsx`:**
    - Add lazy-loaded routes:
      - `/login` -> `LoginPage`
      - `/reset-password` -> `ResetPasswordPage`
      - `/update-password` -> `UpdatePasswordPage`
    - Keep all existing routes unchanged
    - All new pages are inside the Layout (have Navbar)

    **Styling guidelines:**
    - Follow existing project patterns: glassmorphism cards, font-heading for titles, brand color for primary actions
    - Responsive: forms should look good on mobile and desktop
    - Use existing shadcn components (Button, Input, Card) + add Label and Tabs if needed
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes
    - `pnpm build` succeeds
    - `pnpm dev` -- navigate to `#/login`, both tabs render
    - `#/reset-password` renders the reset form
    - All form text is in the current language (PL/EN switch works)
  </verify>
  <done>
    Auth forms (login, signup, reset, update password) created with Supabase integration. LoginPage has tab switching. All 3 auth pages routed. i18n keys added for PL and EN.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UserMenu and integrate into Navbar</name>
  <files>
    src/components/auth/UserMenu.tsx
    src/components/layout/Navbar.tsx
  </files>
  <action>
    **Create `src/components/auth/UserMenu.tsx`:**
    - Uses `useAuthStore` to get `user` and `isLoading`
    - If `isLoading`: render `<Skeleton className="h-8 w-20" />`
    - If no user (guest mode): render a `<Button>` that navigates to `#/login` with text `t('auth.login')` and a `LogIn` icon from lucide-react
    - If user is authenticated: render a shadcn `DropdownMenu`:
      - Trigger: Button with `User` icon + truncated email (max ~20 chars on desktop, icon only on mobile)
      - Items:
        1. `t('auth.myEstimates')` -- navigates to `#/estimates` (page created in Plan 03)
        2. Separator
        3. `t('auth.logout')` -- calls `supabase.auth.signOut()`, handles errors gracefully
    - Use `useNavigate` from react-router for navigation

    **Update `src/components/layout/Navbar.tsx`:**
    - Replace the placeholder `<Button>` with `<User>` icon (the one that says `t("nav.userMenu")`) with `<UserMenu />`
    - In BOTH desktop and mobile sections:
      - Desktop: Replace the ghost Button with `<UserMenu />`
      - Mobile: Replace the ghost Button inside SheetContent with `<UserMenu />`
    - Import `UserMenu` from `@/components/auth/UserMenu`
    - Remove unused `User` import from lucide-react if no longer needed directly
    - Keep all other Navbar functionality unchanged (logo, language toggle, mode toggle, mobile sheet)
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes
    - `pnpm build` succeeds
    - Navbar shows "Login" button when not authenticated
    - After logging in, Navbar shows user dropdown with email and menu items
    - Logout works and returns to Login button state
    - Mobile Navbar sheet also shows correct auth state
  </verify>
  <done>
    UserMenu component shows login button for guests, user dropdown for authenticated users. Navbar placeholder replaced with live UserMenu in both desktop and mobile views.
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` -- no type errors
2. `pnpm build` -- builds successfully
3. Guest mode: wizard at `#/wizard` works identically to Phase 2 (AUTH-01)
4. Sign up: `#/login` > Sign Up tab > enter email+password > account created, user logged in (AUTH-02)
5. Sign in: `#/login` > Login tab > enter credentials > logged in, redirected to home (AUTH-03)
6. Sign out: User menu > Logout > logged out, Navbar shows Login button (AUTH-03)
7. Session persistence: refresh page while logged in > user stays logged in (AUTH-04)
8. Password reset: `#/reset-password` > enter email > reset link sent message (AUTH-05)
9. i18n: Switch PL/EN > all auth UI text changes language
</verification>

<success_criteria>
- Complete auth flow: signup, login, logout, password reset all functional
- Navbar dynamically shows login/user menu based on auth state
- Guest mode wizard is completely unaffected
- All text translated PL/EN
- No flash of unauthenticated content (AuthInit from Plan 01 handles this)
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-cloud-save/03-02-SUMMARY.md`
</output>
