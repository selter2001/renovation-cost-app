---
phase: 03-auth-cloud-save
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/components/estimates/EstimatesList.tsx
  - src/components/estimates/SaveEstimateDialog.tsx
  - src/components/estimates/EstimateActions.tsx
  - src/pages/EstimatesPage.tsx
  - src/components/wizard/SummaryStep.tsx
  - src/router/index.tsx
  - src/i18n/locales/pl/common.json
  - src/i18n/locales/en/common.json
autonomous: true

must_haves:
  truths:
    - "Logged-in user can save current estimate with a name (SAVE-01)"
    - "Logged-in user can see a list of their saved estimates with name and date (SAVE-05)"
    - "Logged-in user can load a saved estimate into the wizard (SAVE-02)"
    - "Logged-in user can overwrite/update a saved estimate (SAVE-03)"
    - "Logged-in user can delete a saved estimate (SAVE-04)"
    - "Guest user in SummaryStep sees a prompt to log in to save (not a crash)"
    - "RLS ensures user sees only their own estimates (SAVE-06)"
    - "Loading an estimate populates the wizard store (rooms + vatRate)"
    - "All estimates UI text is translated PL/EN"
  artifacts:
    - path: "src/components/estimates/EstimatesList.tsx"
      provides: "List of saved estimates with name, date, load/delete actions"
      contains: "supabase.*from.*quotes"
    - path: "src/components/estimates/SaveEstimateDialog.tsx"
      provides: "Dialog to name and save/overwrite current estimate"
      contains: "insert.*quotes"
    - path: "src/components/estimates/EstimateActions.tsx"
      provides: "Load and delete action handlers for individual estimates"
      contains: "delete.*quotes"
    - path: "src/pages/EstimatesPage.tsx"
      provides: "My Estimates page listing saved estimates"
      contains: "EstimatesList"
    - path: "src/router/index.tsx"
      provides: "Route /estimates"
      contains: "estimates"
  key_links:
    - from: "src/components/estimates/SaveEstimateDialog.tsx"
      to: "src/stores/wizard-store.ts"
      via: "reads rooms and vatRate from wizard store to serialize as JSONB"
      pattern: "useWizardStore.*rooms.*vatRate"
    - from: "src/components/estimates/EstimateActions.tsx"
      to: "src/stores/wizard-store.ts"
      via: "populates wizard store when loading an estimate"
      pattern: "useWizardStore\\.setState"
    - from: "src/components/estimates/EstimatesList.tsx"
      to: "src/lib/supabase.ts"
      via: "queries quotes table for user's estimates"
      pattern: "supabase.*from.*quotes.*select"
    - from: "src/components/wizard/SummaryStep.tsx"
      to: "src/components/estimates/SaveEstimateDialog.tsx"
      via: "Save to Cloud button opens SaveEstimateDialog"
      pattern: "SaveEstimateDialog"
---

<objective>
Build the complete estimates CRUD flow: save, load, list, overwrite, and delete saved estimates in Supabase.

Purpose: Logged-in users can persist their renovation estimates to the cloud and manage them. This is the core value of Phase 3 -- cloud save turns a disposable calculator into a persistent tool.

Output: EstimatesPage with full CRUD, SaveEstimateDialog in SummaryStep, and all wiring to Supabase quotes table.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-auth-cloud-save/03-RESEARCH.md
@.planning/phases/03-auth-cloud-save/03-01-SUMMARY.md
@.planning/phases/03-auth-cloud-save/03-02-SUMMARY.md
@src/lib/supabase.ts
@src/stores/auth-store.ts
@src/stores/wizard-store.ts
@src/types/database.ts
@src/types/wizard.ts
@src/components/wizard/SummaryStep.tsx
@src/router/index.tsx
@src/i18n/locales/pl/common.json
@src/i18n/locales/en/common.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create estimates components, EstimatesPage, and route</name>
  <files>
    src/components/estimates/EstimatesList.tsx
    src/components/estimates/SaveEstimateDialog.tsx
    src/components/estimates/EstimateActions.tsx
    src/pages/EstimatesPage.tsx
    src/router/index.tsx
    src/i18n/locales/pl/common.json
    src/i18n/locales/en/common.json
  </files>
  <action>
    **Add i18n keys** to both `pl/common.json` and `en/common.json`:
    - `estimates.title` ("Moje wyceny" / "My Estimates")
    - `estimates.empty` ("Nie masz jeszcze zapisanych wycen" / "You don't have any saved estimates yet")
    - `estimates.save` ("Zapisz wycene" / "Save estimate")
    - `estimates.saveToCloud` ("Zapisz w chmurze" / "Save to cloud")
    - `estimates.name` ("Nazwa wyceny" / "Estimate name")
    - `estimates.namePlaceholder` ("np. Mieszkanie ul. Kwiatowa" / "e.g. Apartment on Flower St.")
    - `estimates.saveButton` ("Zapisz" / "Save")
    - `estimates.updateButton` ("Nadpisz" / "Overwrite")
    - `estimates.load` ("Wczytaj" / "Load")
    - `estimates.delete` ("Usun" / "Delete")
    - `estimates.deleteConfirm` ("Czy na pewno chcesz usunac te wycene?" / "Are you sure you want to delete this estimate?")
    - `estimates.saved` ("Wycena zapisana" / "Estimate saved")
    - `estimates.loaded` ("Wycena wczytana" / "Estimate loaded")
    - `estimates.deleted` ("Wycena usunieta" / "Estimate deleted")
    - `estimates.updated` ("Wycena nadpisana" / "Estimate overwritten")
    - `estimates.loginToSave` ("Zaloguj sie, aby zapisac wycene w chmurze" / "Log in to save your estimate to the cloud")
    - `estimates.rooms` ("{count} pokoi" / "{count} rooms") -- for list item subtitle
    - `estimates.errors.saveFailed` / `estimates.errors.loadFailed` / `estimates.errors.deleteFailed`

    **Create `src/components/estimates/SaveEstimateDialog.tsx`:**
    - shadcn Dialog component
    - Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `existingEstimateId?: string`, `existingName?: string`
    - If `existingEstimateId` is provided, dialog is in "overwrite" mode (update instead of insert)
    - Input for estimate name (required, non-empty)
    - Save button that:
      1. Reads `rooms` and `vatRate` from `useWizardStore.getState()` (NOT hook, since we want snapshot at save time)
      2. Gets session from `useAuthStore`
      3. If inserting: `supabase.from('quotes').insert({ user_id: session.user.id, name, data: { rooms, vatRate } }).select().single()`
      4. If updating: `supabase.from('quotes').update({ name, data: { rooms, vatRate } }).eq('id', existingEstimateId)`
      5. On success: show success toast/message, close dialog
      6. On error: show error message in dialog
    - Loading state on save button
    - For toast/success feedback: use a simple state-based message below the form (or install shadcn sonner/toast if desired -- implementer's discretion)

    **Create `src/components/estimates/EstimateActions.tsx`:**
    - Provides action handler functions (not a visual component, more of a hooks/utils module):
      - `useLoadEstimate()`: hook that returns an async function
        - Fetches quote by ID: `supabase.from('quotes').select('*').eq('id', quoteId).single()`
        - Parses `data` as `QuoteData`
        - Calls `useWizardStore.setState({ rooms: data.rooms, vatRate: data.vatRate, currentStep: 0 })`
        - Navigates to `#/wizard` using `useNavigate`
      - `useDeleteEstimate()`: hook that returns an async function
        - Calls `supabase.from('quotes').delete().eq('id', quoteId)`
        - Returns success/error
    - OR: these can be inline in EstimatesList. Implementer's discretion on extraction.

    **Create `src/components/estimates/EstimatesList.tsx`:**
    - Fetches user's estimates on mount: `supabase.from('quotes').select('id, name, data, created_at, updated_at').order('updated_at', { ascending: false })`
    - RLS automatically filters to current user's quotes only
    - Loading state with Skeleton
    - Empty state with message and link to wizard
    - List of estimate cards/rows, each showing:
      - Estimate name
      - Room count (extracted from data.rooms.length)
      - Last updated date (formatted with Intl.DateTimeFormat)
      - Action buttons: Load (navigates to wizard with data populated), Delete (with confirmation)
      - Overwrite button (opens SaveEstimateDialog in update mode with current wizard state)
    - Delete confirmation: use `window.confirm()` or a simple inline confirm state (keep it simple)
    - After delete: refetch list or optimistically remove from state
    - After load: navigate to `#/wizard` with store populated

    **Create `src/pages/EstimatesPage.tsx`:**
    - Auth guard: if not authenticated (`useAuthStore` user is null and not loading), redirect to `#/login`
    - Page title with glassmorphism card styling
    - Renders `<EstimatesList />`
    - "New estimate" button that navigates to `#/wizard` (resets wizard store first via `resetWizard()`)

    **Update `src/router/index.tsx`:**
    - Add lazy-loaded route: `/estimates` -> `EstimatesPage`
    - Keep all existing routes unchanged
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes
    - `pnpm build` succeeds
    - Navigate to `#/estimates` while logged in -- page renders
    - Navigate to `#/estimates` while logged out -- redirects to `#/login`
    - Empty state shows when no estimates saved
    - All text is in the current language
  </verify>
  <done>
    Estimates CRUD components created. EstimatesPage shows list of saved estimates with load/delete actions. SaveEstimateDialog handles both insert and update. Route `/estimates` added. i18n keys for PL and EN added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Save to Cloud button into SummaryStep</name>
  <files>
    src/components/wizard/SummaryStep.tsx
  </files>
  <action>
    **Update `src/components/wizard/SummaryStep.tsx`:**

    1. Import `useAuthStore` from `@/stores/auth-store`
    2. Import `SaveEstimateDialog` from `@/components/estimates/SaveEstimateDialog`
    3. Add state for dialog: `const [saveDialogOpen, setSaveDialogOpen] = useState(false)`
    4. Get user from auth store: `const user = useAuthStore((s) => s.user)`

    5. Add a "Save to Cloud" section BELOW the existing PDF export buttons:
       - If user is authenticated:
         - Button with cloud/save icon (e.g. `CloudUpload` or `Save` from lucide-react) and text `t('estimates.saveToCloud')`
         - On click: open SaveEstimateDialog
       - If user is NOT authenticated:
         - Show a subtle prompt: `t('estimates.loginToSave')` with a link/button to `#/login`
         - Style: muted text, smaller size, non-intrusive (guest experience should not feel incomplete)

    6. Render `<SaveEstimateDialog open={saveDialogOpen} onOpenChange={setSaveDialogOpen} />` at the bottom of the component

    IMPORTANT: Do NOT change any existing SummaryStep functionality. The PDF export, room breakdown, totals -- everything stays identical. This is purely ADDITIVE.

    **Styling:**
    - Save to Cloud button should visually complement the PDF export buttons (similar size/style but different color -- e.g., brand color instead of default)
    - Place it in a logical position: after PDF export section, separated by a subtle divider or spacing
    - Login prompt for guests should be subtle/muted -- not a blocker or modal
  </action>
  <verify>
    - `pnpm exec tsc --noEmit` passes
    - `pnpm build` succeeds
    - SummaryStep as guest: shows login prompt, no save button
    - SummaryStep as logged-in user: shows "Save to Cloud" button
    - Clicking save button opens SaveEstimateDialog
    - After saving, estimate appears in EstimatesPage list
    - Existing PDF export and summary functionality is unchanged
  </verify>
  <done>
    SummaryStep has "Save to Cloud" button for authenticated users and a subtle login prompt for guests. SaveEstimateDialog is wired and functional. Full round-trip: create estimate in wizard -> save to cloud -> see in My Estimates -> load back into wizard.
  </done>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit` -- no type errors
2. `pnpm build` -- builds successfully
3. Full CRUD round-trip:
   a. Create estimate in wizard (rooms, dimensions, works)
   b. Save to cloud from SummaryStep
   c. Navigate to My Estimates -- estimate appears with name and date
   d. Load the estimate -- wizard populates with saved data
   e. Modify, save again (overwrite) -- updated_at changes
   f. Delete estimate -- removed from list
4. Guest mode: wizard works without auth, SummaryStep shows login prompt (not error)
5. RLS: logged-in user only sees their own estimates (SAVE-06)
6. i18n: all estimates UI text changes with PL/EN switch
</verification>

<success_criteria>
- Save, load, overwrite, delete estimates all functional (SAVE-01 through SAVE-05)
- Guest users see login prompt in SummaryStep, not broken UI (AUTH-01)
- RLS policies enforced at database level (SAVE-06)
- Full round-trip works: create -> save -> load -> edit -> overwrite -> delete
- All text translated PL/EN
- Existing wizard and PDF functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-cloud-save/03-03-SUMMARY.md`
</output>
